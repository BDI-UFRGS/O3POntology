# Suggested replacement for .github/workflows/widoco.yaml
# - Fix path patterns
# - Allow manual runs (workflow_dispatch)
# - Auto-detect a .ttl file if present (first match)
# - Explicitly set token for deploy
name: Deploy Ontology Docs

on:
  push:
    branches:
      - main
    paths:
      - '**/*.ttl'
      - '.github/workflows/widoco.yaml'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Set up JDK 11
        uses: actions/setup-java@v3
        with:
          java-version: '11'
          distribution: 'temurin'

      - name: üîç Debug - List files in root
        run: |
          echo "Workdir: $(pwd)"
          ls -la
          echo "--- repo tree ---"
          find . -maxdepth 3 -type f -print

      - name: Download Widoco
        run: wget https://github.com/dgarijo/Widoco/releases/download/v1.4.25/widoco-1.4.25-jar-with-dependencies_JDK-11.jar -O widoco.jar

      - name: Generate Documentation
        run: |
          mkdir -p public

          # try to detect a TTL file in repository (first match)
          ONTOLOGY_FILE=$(find . -maxdepth 3 -name '*.ttl' | grep -v '^./.github' | head -n1 | sed 's|^\./||')
          if [ -z "$ONTOLOGY_FILE" ]; then
            echo "‚ùå ERRO CR√çTICO: No .ttl file found in repo (searched up to depth 3)."
            exit 1
          fi

          echo "Detected ontology file: $ONTOLOGY_FILE"

          java -jar widoco.jar \
            -ontFile "$ONTOLOGY_FILE" \
            -outFolder public \
            -rewriteAll \
            -webVowl \
            -lang en,pt \
            -getOntologyMetadata \
            -oops

          echo "Contents of generated public/:"
          ls -la public || true

          if [ -f "public/index-en.html" ]; then
            cp public/index-en.html public/index.html
            echo "‚úÖ index.html created from index-en.html"
          else
            echo "‚ö†Ô∏è index-en.html not generated. Check Widoco output."
          fi

      - name: Deploy to GitHub Pages
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          folder: public
          branch: gh-pages
          token: ${{ secrets.GITHUB_TOKEN }}
